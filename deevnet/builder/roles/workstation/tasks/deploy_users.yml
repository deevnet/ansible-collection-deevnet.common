- name: Debug dev_users (inside role)
  ansible.builtin.debug:
    var: dev_users

- name: Ensure primary groups for dev users exist
  ansible.builtin.group:
    name: "{{ user.primary_group | default(user.name) }}"
    state: present
  loop: "{{ dev_users | default([]) }}"
  loop_control:
    loop_var: user

- name: Ensure dev users exist
  ansible.builtin.user:
    name: "{{ user.name }}"
    group: "{{ user.primary_group | default(user.name) }}"
    groups: "{{ user.extra_groups | default([]) }}"
    append: true
    shell: "{{ user.shell | default('/bin/bash') }}"
    create_home: true
    state: present
  loop: "{{ dev_users | default([]) }}"
  loop_control:
    loop_var: user

- name: Ensure .ssh directory exists for dev users
  ansible.builtin.file:
    path: "{{ user.home | default('/home/' + user.name) }}/.ssh"
    state: directory
    owner: "{{ user.name }}"
    group: "{{ user.primary_group | default(user.name) }}"
    mode: '0700'
  loop: "{{ dev_users | default([]) }}"
  loop_control:
    loop_var: user

- name: Install authorized_keys for dev users from URL (GitHub or other)
  ansible.builtin.get_url:
    url: "{{ user.github_keys_url }}"
    dest: "{{ user.home | default('/home/' + user.name) }}/.ssh/authorized_keys"
    owner: "{{ user.name }}"
    group: "{{ user.primary_group | default(user.name) }}"
    mode: '0600'
  when: user.github_keys_url is defined
  loop: "{{ dev_users | default([]) }}"
  loop_control:
    loop_var: user

- name: Ensure DEEVNET X11 auto-DISPLAY block in .bashrc
  become: true
  blockinfile:
    path: "{{ item.home }}/.bashrc"
    create: true
    owner: "{{ item.name }}"
    group: "{{ item.primary_group }}"
    mode: '0644'
    marker: "# {mark} DEEVNET X11 DISPLAY BLOCK"
    block: |
      # --- DEEVNET X11 AUTO-DISPLAY ---
      # Set DISPLAY only if:
      #  1. DISPLAY is not already set (i.e. not ssh -X)
      #  2. This is an SSH session (SSH_CLIENT present)
      #  3. The SSH client is assumed to run an X server (e.g. Mac XQuartz)
      if [ -z "$DISPLAY" ] && [ -n "$SSH_CLIENT" ]; then
        # SSH_CLIENT="client_ip client_port server_port"
        export DISPLAY="$(echo "$SSH_CLIENT" | awk '{print $1}'):0"
      fi
      # --- END DEEVNET X11 AUTO-DISPLAY ---
  loop: "{{ dev_users }}"
  loop_control:
    label: "{{ item.name }}"

- name: Ensure per-user npm-global directory exists
  become: true
  become_user: "{{ item.name }}"
  loop: "{{ dev_users }}"
  file:
    path: "{{ item.home }}/.npm-global"
    state: directory
    mode: "0755"

- name: Ensure per-user .npmrc sets prefix to ~/.npm-global
  become: true
  become_user: "{{ item.name }}"
  loop: "{{ dev_users }}"
  lineinfile:
    path: "{{ item.home }}/.npmrc"
    regexp: '^prefix='
    line: "prefix={{ item.home }}/.npm-global"
    create: true

- name: Ensure npm-global/bin is on PATH in dev users' bashrc
  become: true
  become_user: "{{ item.name }}"
  loop: "{{ dev_users }}"
  lineinfile:
    path: "{{ item.home }}/.bashrc"
    regexp: 'npm-global/bin'
    line: 'export PATH="$HOME/.npm-global/bin:$PATH"'
    insertafter: EOF
    create: true
