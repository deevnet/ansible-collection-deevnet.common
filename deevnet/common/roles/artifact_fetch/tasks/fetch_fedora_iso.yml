---
# Fedora ISO download with GPG + checksum validation

- name: Ensure temp directory exists
  ansible.builtin.file:
    path: "/tmp/fedora_iso_{{ artifact_item.name }}"
    state: directory
    mode: "0700"
  become: true

- name: Download Fedora GPG key
  ansible.builtin.get_url:
    url: "{{ artifact_item.gpg_key_url }}"
    dest: "/tmp/fedora_iso_{{ artifact_item.name }}/fedora.gpg"
    mode: "0644"
  become: true

- name: Download Fedora checksum file
  ansible.builtin.get_url:
    url: "{{ artifact_item.checksum_url }}"
    dest: "/tmp/fedora_iso_{{ artifact_item.name }}/CHECKSUM"
    mode: "0644"
  become: true

- name: Verify checksum signature
  ansible.builtin.command:
    cmd: >
      gpgv --keyring /tmp/fedora_iso_{{ artifact_item.name }}/fedora.gpg
      /tmp/fedora_iso_{{ artifact_item.name }}/CHECKSUM
  register: gpg_verify
  changed_when: false
  failed_when: gpg_verify.rc != 0
  become: true

- name: Download Fedora ISO
  ansible.builtin.get_url:
    url: "{{ artifact_item.iso_url }}"
    dest: "/tmp/fedora_iso_{{ artifact_item.name }}/{{ artifact_item.dest_filename }}"
    mode: "0644"
  become: true

- name: Verify ISO checksum
  ansible.builtin.command:
    cmd: >
      sha256sum --ignore-missing -c /tmp/fedora_iso_{{ artifact_item.name }}/CHECKSUM
  args:
    chdir: "/tmp/fedora_iso_{{ artifact_item.name }}"
  register: checksum_verify
  changed_when: false
  failed_when: checksum_verify.rc != 0
  become: true

- name: Ensure destination directory exists
  ansible.builtin.file:
    path: "{{ nginx_artifacts_root }}/{{ artifact_item.dest_subdir }}"
    state: directory
    mode: "0755"
  become: true

- name: Publish ISO to artifacts directory
  ansible.builtin.copy:
    src: "/tmp/fedora_iso_{{ artifact_item.name }}/{{ artifact_item.dest_filename }}"
    dest: "{{ nginx_artifacts_root }}/{{ artifact_item.dest_subdir }}/{{ artifact_item.dest_filename }}"
    remote_src: true
  become: true

- name: Remove temporary Fedora download directory
  ansible.builtin.file:
    path: "/tmp/fedora_iso_{{ artifact_item.name }}"
    state: absent
  become: true