# Publish SSH public key artifact from inventory content
# Expects: artifact_item with fields:
#   - name
#   - dest_subdir
#   - dest_filename
#   - public_key
- name: Ensure SSH key destination directory exists
  ansible.builtin.file:
    path: "{{ nginx_artifacts_root }}/{{ artifact_item.dest_subdir }}"
    state: directory
    mode: "0755"
  become: true

- name: Compute expected checksum for {{ artifact_item.name }} public key
  ansible.builtin.set_fact:
    ssh_key_expected_checksum: "{{ artifact_item.public_key | trim | hash('sha256') }}"

- name: Stat existing {{ artifact_item.name }} public key file
  ansible.builtin.stat:
    path: "{{ nginx_artifacts_root }}/{{ artifact_item.dest_subdir }}/{{ artifact_item.dest_filename }}"
    checksum_algorithm: sha256
  register: ssh_key_stat
  become: true

- name: Install/update SSH public key {{ artifact_item.name }}
  ansible.builtin.copy:
    dest: "{{ nginx_artifacts_root }}/{{ artifact_item.dest_subdir }}/{{ artifact_item.dest_filename }}"
    mode: "0644"
    content: "{{ artifact_item.public_key | trim }}"
  become: true
  when: >
    (not ssh_key_stat.stat.exists) or
    (ssh_key_stat.stat.checksum is defined and
     ssh_key_stat.stat.checksum != ssh_key_expected_checksum)